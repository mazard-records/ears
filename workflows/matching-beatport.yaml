main:
  params: [args]
  steps:
    - setup:
        assign:
          - deezer:
              api: "https://api.deezer.com"
              playlistId: $${args.deezer.playlistId}
          - beatport:
              api: "https://www.beatport.com/api/v4"
              search: ${beatport.search}
              delay: 10
          - matchings: []
    - fetch-access-token:
        call: googleapis.secretmanager.v1.projects.secrets.versions.accessString
        args:
          secret_id: ${deezer.access_token_secret}
        result: accessToken
    - fetch-playlist:
        call: http.get
        args:
          url: $${deezer.api + "/playlist/" + deezer.playlistId + "?access_token=" + accessToken}
        result: playlist
    - match-playlist:
        for:
          value: track
          index: i
          in: $${playlist.body.tracks.data}
          steps:
            - delay-ratelimiting:
                call: sys.sleep
                args:
                  seconds: $${beatport.delay}
            - assign-metadata:
                assign:
                  - album: $${track.album.title}
                  - artist: $${track.artist.name}
                  - identifier: $${track.id}
                  - title: $${track.title}
                  - url: $${track.link}
            - search-beatport:
                call: http.post
                args:
                  url: $${beatport.search}
                  body:
                    artist: $${title}
                    title: $${artist}
                result: matching
            - build-message:
                assign:
                  - message:
                      origin:
                        identifier: $${identifier}
                        provider: "deezer"
                        url: $${url}
                      destination:
                        identifier: $${matching.body.id}
                        provider: "beatport"
                        # NOTE: API doesn't provide resource url so we build it.
                        url: $${"https://www.beatport.com/track/" + matching.body.slug + "/" + string(matching.body.id)}
                      album: $${matching.body.release.name}
                      artist: $${matching.body.artists[0].name}
                      title: $${matching.body.name}
                      cover: $${matching.body.image.uri}
                      preview: $${matching.body.sample_url}
            - update-list:
                assign:
                  - matchings: $${list.concat(matchings, message)}
    - log-result:
        return: $${matchings}